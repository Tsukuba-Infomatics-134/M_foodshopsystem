<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ¡é™°ç¥­2025 é£Ÿè²©å‘¼ã³å‡ºã—çŠ¶æ³ç¢ºèª</title>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        padding: 40px 20px;
      }
      h1 {
        font-size: 2em;
        margin-bottom: 0.2em;
      }
      h2 {
        font-size: 1.2em;
        font-weight: normal;
        margin-bottom: 2em;
      }
      input {
        font-size: 1.2em;
        padding: 15px;
        width: 80%;
        max-width: 350px;
        border: 2px solid black;
        border-radius: 10px;
        margin-bottom: 30px;
        box-sizing: border-box;
        text-align: center;
      }
      button {
        font-size: 1em;
        padding: 12px 40px;
        border: none;
        border-radius: 8px;
        background-color: #dcdcdc;
        cursor: pointer;
      }
      button:hover {
        background-color: #bfbfbf;
      }
      body {
        font-family: sans-serif;
        text-align: center;
        padding: 20px;
      }
      h1 {
        font-size: 2em;
        margin-bottom: 0.2em;
      }
      h2 {
        font-size: 1.2em;
        font-weight: normal;
        margin-bottom: 1em;
      }
      .store {
        font-size: 1.2em;
        color: #4169e1;
        margin-bottom: 2em;
      }
      .label {
        font-size: 1.2em;
        margin-top: 1.5em;
        margin-bottom: 0.3em;
      }
      .orderNum {
        font-size: 5em;
        font-weight: bold;
        color: #4169e1;
        margin: 0.2em 0 1em 0;
      }
      .status {
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 2em;
      }
      .order {
        font-size: 1.2em;
        margin-bottom: 1em;
      }
      .items {
        text-align: left;
        display: inline-block;
        font-size: 1.1em;
        line-height: 1.8;
      }
    </style>
  </head>
  <body>
    <div id="root">
      <h1>æ¡é™°ç¥­2025</h1>
      <h2>é£Ÿè²©å‘¼ã³å‡ºã—çŠ¶æ³ç¢ºèªãƒšãƒ¼ã‚¸</h2>
      <form>
        <input type="text" placeholder="æ³¨æ–‡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
        <br />
        <button type="submit">é€ä¿¡</button>
      </form>
    </div>
    <div id="status">
      <h1>æ¡é™°ç¥­2025</h1>
      <h2>é£Ÿè²©å‘¼ã³å‡ºã—çŠ¶æ³ç¢ºèªãƒšãƒ¼ã‚¸</h2>
      <div class="store">æ¡é Œå €ã€€ï¼ˆ2çµ„ï¼‰</div>
      <button id="reload-btn">å†èª­ã¿è¾¼ã¿</button>
      <div class="ordertext">å—ä»˜ç•ªå·</div>
      <div class="orderNum">123</div>

      <div class="label">å‘¼ã³å‡ºã—çŠ¶æ³</div>
      <div class="status">ã¾ã ã§ã™</div>

      <div class="label">æ³¨æ–‡å†…å®¹</div>
      <div class="items">
        ãƒ—ãƒ¬ãƒ¼ãƒ³ï¼š1å€‹<br />
        ãƒãƒ¼ã‚ºã€€ï¼š0å€‹
      </div>
      <div class="label">æœ€çµ‚æ›´æ–°æ—¥æ™‚</div>
      <div id="last-updated" style="font-size: 1em; margin-bottom: 2em"></div>
    </div>
  </body>
  <script>
    // const apiurl_production = "https://api.yaakiyu.f5.si/";
    const apiurl_dev = "http://localhost:80/";
    let apiurl = apiurl_dev;

    // devã‚µãƒ¼ãƒãƒ¼ãŒç”Ÿãã¦ã„ã‚Œã°apiurlã‚’devã«åˆ‡ã‚Šæ›¿ãˆã‚‹
    function tryDevApiUrlSwitch() {
      fetch(apiurl_dev + "version", { method: "GET", cache: "no-store" })
        .then((res) => {
          if (res.ok) {
            apiurl = apiurl_dev;
            console.warn("apiurlã‚’é–‹ç™ºç’°å¢ƒã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ");
          }
        })
        .catch(() => {
          // devã‚µãƒ¼ãƒãƒ¼ãŒè½ã¡ã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
        });
    }
    tryDevApiUrlSwitch();

    function sendRequest() {
      const params = new URLSearchParams(window.location.search);
      const orderNum = parseInt(params.get("order") || "", 0);
      const password_ = parseInt(params.get("pw") || "", 0);
      fetch(apiurl + "mobile/get_order/" + orderNum, {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          password: password_,
        },
      })
        .then(async (response) => {
          if (response.status === 200) {
            return response.json();
          } else {
            console.error("Error:", response.text());
            alert("æ³¨æ–‡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
            return null;
          }
        })
        .then((data) => {
          if (data) {
            console.log("Success:", data);
            // åº—åãƒ»ç•ªå·ãƒ»çŠ¶æ³ã‚’åæ˜ 
            document.querySelector(".store").innerText = data["type"];
            document.querySelector(".orderNum").innerText = data["id"];
            document.querySelector(".status").innerText = data["status"];

            // æ³¨æ–‡å†…å®¹ã‚’çµ„ã¿ç«‹ã¦ã¦åæ˜ 
            let itemsHtml = "";
            for (const [name, count] of Object.entries(data["order_items"])) {
              itemsHtml += `${name}ï¼š${count}å€‹<br/>`;
            }
            document.querySelector(".items").innerHTML = itemsHtml;
          } else {
            return;
          }
        });
      console.log(orderNum, password_, "ç•ªç›®ã®æ³¨æ–‡ã‚’ç¢ºèªã—ã¾ã™");
    }
    function hashchanged(hash) {
      const now = Date.now();
      const lastRequestTime = parseInt(localStorage.getItem("pre_time") || "0");
      document.getElementById("last-updated").innerText = new Date(
        lastRequestTime
      ).toLocaleString("ja-JP", { hour12: false });
      if (now - lastRequestTime < 10000) {
        //ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«å‰å›ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ®‹ã—ã¦ãŠã„ã¦ã€ãã‚Œã‚’è¡¨ç¤ºã™ã‚‹
        console.log(lastRequestTime);
        console.log(now - lastRequestTime);
        console.log("Toooooooo many request");
        document.getElementById("root").style.display = "none";
        document.getElementById("status").style.display = "block";
        return;
      }
      localStorage.setItem("pre_time", now);
      document.getElementById("last-updated").innerText = new Date(
        now
      ).toLocaleString("ja-JP", { hour12: false });
      document.getElementsByClassName("orderNum")[0].innerText =
        location.hash.substring(1);
      if (location.hash.substring(1) != "" || true) {
        sendRequest(location.hash.substring(1));
        document.getElementById("root").style.display = "none";
        document.getElementById("status").style.display = "block";
      } else {
        document.getElementById("root").style.display = "block";
        document.getElementById("status").style.display = "none";
      }
    }
    window.addEventListener("hashchange", () => {
      hashchanged();
    });
    window.addEventListener("DOMContentLoaded", () => {
      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸå€¤ã‚’è¡¨ç¤º
      hashchanged();

      // ğŸ”½ å†èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³å‡¦ç†
      document.getElementById("reload-btn").addEventListener("click", () => {
        console.log("å†èª­ã¿è¾¼ã¿");
        hashchanged();
      });
    });
  </script>
</html>

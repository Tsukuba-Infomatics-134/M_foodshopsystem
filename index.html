<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>桐陰祭2025 食販呼び出し状況確認</title>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        padding: 40px 20px;
      }
      h1 {
        font-size: 2em;
        margin-bottom: 0.2em;
      }
      h2 {
        font-size: 1.2em;
        font-weight: normal;
        margin-bottom: 2em;
      }
      input {
        font-size: 1.2em;
        padding: 15px;
        width: 80%;
        max-width: 350px;
        border: 2px solid black;
        border-radius: 10px;
        margin-bottom: 30px;
        box-sizing: border-box;
        text-align: center;
      }
      button {
        font-size: 1em;
        padding: 12px 40px;
        border: none;
        border-radius: 8px;
        background-color: #dcdcdc;
        cursor: pointer;
      }
      button:hover {
        background-color: #bfbfbf;
      }
      body {
        font-family: sans-serif;
        text-align: center;
        padding: 20px;
      }
      h1 {
        font-size: 2em;
        margin-bottom: 0.2em;
      }
      h2 {
        font-size: 1.2em;
        font-weight: normal;
        margin-bottom: 1em;
      }
      .store {
        font-size: 1.2em;
        color: #4169e1;
        margin-bottom: 2em;
      }
      .label {
        font-size: 1.2em;
        margin-top: 1.5em;
        margin-bottom: 0.3em;
      }
      .orderNum {
        font-size: 5em;
        font-weight: bold;
        color: #4169e1;
        margin: 0.2em 0 1em 0;
      }
      .status {
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 2em;
      }
      .order {
        font-size: 1.2em;
        margin-bottom: 1em;
      }
      .items {
        text-align: left;
        display: inline-block;
        font-size: 1.1em;
        line-height: 1.8;
      }
    </style>
  </head>
  <body>
    <div id="root">
      <h1>桐陰祭2025</h1>
      <h2>食販呼び出し状況確認ページ</h2>
      <form>
        <input type="text" placeholder="注文番号を入力してください" />
        <br />
        <button type="submit">送信</button>
      </form>
    </div>
    <div id="status">
      <h1>桐陰祭2025</h1>
      <h2>食販呼び出し状況確認ページ</h2>
      <div class="store">桐頌堀　（2組）</div>
      <button id="reload-btn">再読み込み</button>
      <div class="ordertext">受付番号</div>
      <div class="orderNum">123</div>

      <div class="label">呼び出し状況</div>
      <div class="status">まだです</div>

      <div class="label">注文内容</div>
      <div class="items">
        プレーン：1個<br />
        チーズ　：0個
      </div>
      <div class="label">最終更新日時</div>
      <div id="last-updated" style="font-size: 1em; margin-bottom: 2em"></div>
    </div>
  </body>
  <script>
    const apiurl_production = "https://api.yaakiyu.f5.si/";
    const apiurl_dev = "http://localhost:80/";
    let apiurl = apiurl_production;

    // devサーバーが生きていればapiurlをdevに切り替える
    function tryDevApiUrlSwitch() {
      fetch(apiurl_dev + "version", { method: "GET", cache: "no-store" })
        .then((res) => {
          if (res.ok) {
            apiurl = apiurl_dev;
            console.warn("apiurlを開発環境に切り替えました");
          }
        })
        .catch(() => {
          // devサーバーが落ちている場合は何もしない
        });
    }
    tryDevApiUrlSwitch();

    const classDatas = [
      {}, // 管理者用
      {
        // 1組
        store: "ベビカスの焼き方",
        variety: 2,
        title: ["ベビーカステラ(プレーン)", "ベビーカステラ(抹茶)"],
        explain: ["ただのベビカス", "少し違うベビカス"],
        picture: ["", ""],
        price: [100, 100],
        limit: 10,
        bgimage:
          "https://illust.download/wp-content/uploads/2017/11/background134.jpg",
      },
      {
        // 2組
        store: "桐頌堀",
        variety: 2,
        title: ["お好み焼き(プレーン)", "お好み焼き(チーズ入り)"],
        explain: ["ただのお好み焼き", "少し黄色いお好み焼き"],
        picture: ["", ""],
        price: [100, 100],
        limit: 10,
        bgimage:
          "https://illust.download/wp-content/uploads/2017/11/background137.jpg",
      },

      {
        // 3組
        store: "だんご3-3兄弟",
        variety: 2,
        title: ["みたらしきなこ団子", "カラフルあんこ団子"],
        explain: ["みたらし (きなこトッピング可能)", "あんこ"],
        picture: ["", ""],
        price: [100, 100],
        limit: 10,
        bgimage:
          "https://illust.download/wp-content/uploads/2017/11/background135.jpg",
      },
      {
        // 4組
        store: "もりてつフローズンパラダイス",
        variety: 2,
        title: ["かき氷(抹茶白玉小豆)", "かき氷(マンゴー)"],
        explain: ["抹茶味で白玉と小豆があるやつ", "マンゴー味"],
        picture: ["", ""],
        price: [100, 100],
        limit: 10,
        bgimage:
          "https://illust.download/wp-content/uploads/2017/11/background138.jpg",
      },
      {
        // 5組
        store: "じゃがいもだけじゃだめですか",
        variety: 2,
        title: [
          "シャカシャカポテト(コンソメ)",
          "シャカシャカポテト(バター醤油)",
        ],
        explain: ["うまい", "うまい"],
        picture: ["", ""],
        price: [200, 200],
        limit: 10,
        bgimage:
          "https://illust.download/wp-content/uploads/2017/11/background136.jpg",
      },

      {
        // 6組
        store: "ひっぱりだこ",
        variety: 2,
        title: ["たこ焼き", "たこ焼き(明太もちチーズ)"],
        explain: ["通常", "突然変異"],
        picture: ["", ""],
        price: [100, 100],
        limit: 10,
        bgimage:
          "https://illust.download/wp-content/uploads/2017/11/background133.jpg",
      },
    ];

    function sendRequest() {
      const params = new URLSearchParams(window.location.search);
      const orderNum = parseInt(params.get("order") || "", 0);
      const password_ = parseInt(params.get("pw") || "", 0);
      fetch(apiurl + "mobile/get_order/" + orderNum, {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          password: password_,
        },
      })
        .then(async (response) => {
          if (response.status === 200) {
            return response.json();
          } else if(response.status===404){
            console.error("Error:", response.text());
            alert("注文番号が間違っています");
            return null;
          } else if(response.status===403){
            console.error("Error:", response.text());
            alert("パスワードが間違っています");
            return null;
          }
        })
        .then((data) => {
          if (data) {
            console.log("Success:", data);
            // 店名・番号・状況を反映
            document.querySelector(".store").innerText =
              classDatas[data["user"]].store;
            document.querySelector(".orderNum").innerText = data["id"];
            document.querySelector(".status").innerText = data["status"];
            if(data["status"]==="呼び出し待ち"){
              //Todo:待ち人数表示 data["wait_number"]
            }
            else if(data["status"]==="キャンセル済み"){
              
            }
            else{
              //elseで繋いでいるが、他のステータスに対応するにはきちんと全部列挙したほうがよい
              document.querySelector(".status").innerText = "呼び出し中";
            }

            // 注文内容を組み立てて反映
            let itemsHtml = "";
            itemsHtml += `${classDatas[data["user"]].title[0]}：${
              data["order_items"]["item_1"]
            }個<br/>`;
            itemsHtml += `${classDatas[data["user"]].title[1]}：${
              data["order_items"]["item_2"]
            }個<br/>`;

            document.querySelector(".items").innerHTML = itemsHtml;
          } else {
            return;
          }
        });
      console.log(orderNum, password_, "番目の注文を確認します");
    }
    function hashchanged(hash) {
      const now = Date.now();
      const lastRequestTime = parseInt(localStorage.getItem("pre_time") || "0");
      document.getElementById("last-updated").innerText = new Date(
        lastRequestTime
      ).toLocaleString("ja-JP", { hour12: false });
      if (now - lastRequestTime < 10000) {
        //キャッシュに前回のデータを残しておいて、それを表示する
        console.log(lastRequestTime);
        console.log(now - lastRequestTime);
        console.log("Toooooooo many request");
        document.getElementById("root").style.display = "none";
        document.getElementById("status").style.display = "block";
        return;
      }
      localStorage.setItem("pre_time", now);
      document.getElementById("last-updated").innerText = new Date(
        now
      ).toLocaleString("ja-JP", { hour12: false });
      document.getElementsByClassName("orderNum")[0].innerText =
        location.hash.substring(1);
      if (location.hash.substring(1) != "" || true) {
        sendRequest(location.hash.substring(1));
        document.getElementById("root").style.display = "none";
        document.getElementById("status").style.display = "block";
      } else {
        document.getElementById("root").style.display = "block";
        document.getElementById("status").style.display = "none";
      }
    }
    window.addEventListener("hashchange", () => {
      hashchanged();
    });
    window.addEventListener("DOMContentLoaded", () => {
      // ページ読み込み時の初期値を表示
      hashchanged();

      // 🔽 再読み込みボタン処理
      document.getElementById("reload-btn").addEventListener("click", () => {
        console.log("再読み込み");
        hashchanged();
      });
    });
  </script>
</html>

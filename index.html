<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>桐陰祭2025 食販呼び出し状況確認</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div id="root">
            <div class="card text-center">
                <div class="card-header">
                    <h1>桐陰祭2025</h1>
                </div>
                <div class="card-body">
                    <h2 class="card-title">食販呼び出し状況確認ページ</h2>
                    <form>
                        <div class="mb-3">
                            <input type="text" name="order" class="form-control" placeholder="注文番号を入力してください" required>
                        </div>
                        <div class="mb-3">
                            <input type="password" name="pw" class="form-control" placeholder="パスワードを入力してください">
                        </div>
                        <button type="submit" class="btn btn-primary">送信</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="status" style="display: none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="mb-0">桐陰祭2025</h1>
                        <h2 class="mb-0">食販呼び出し状況確認ページ</h2>
                    </div>
                    <button id="reload-btn" class="btn btn-secondary">再読み込み</button>
                </div>
                <div class="card-body text-center">
                    <div class="store-info mb-3">
                        <span class="store h5"></span>
                    </div>
                    <div class="order-status mb-4">
                        <div class="label">整理番号</div>
                        <div class="orderNum display-1 fw-bold">読み込み中...</div>
                    </div>
                    <div class="call-status mb-4">
                        <div class="label">呼び出し状況</div>
                        <div class="status h2 fw-bold">まだです</div>
                    </div>
                    <div class="order-details mb-4">
                        <div class="label">注文内容</div>
                        <div class="items"></div>
                    </div>
                    <div class="last-updated-info">
                        <div class="label">最終更新日時</div>
                        <div id="last-updated"></div>
                    </div>
                     <div id="cancellation-section" class="mt-4" style="display: none;">
                        <div class="label">キャンセル予定</div>
                        <div id="cancellation-info" class="h5"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    const apiurl_production = "https://api.yaakiyu.f5.si/";
    const apiurl_dev = "https://didactic-space-bassoon-r4wxv7xv79w4cj5g-80.app.github.dev/"
    let apiurl = apiurl_production;
    let cancellationInterval;
    let lastFullData = {};

    const classDatas = [
      {}, // 管理者用
      {
        // 1組
        store: "ベビカスの焼き方",
        variety: 2,
        title: ["ベビーカステラ(プレーン)", "ベビーカステラ(抹茶)"],
        explain: ["ただのベビカス", "少し違うベビカス"],
        picture: ["", ""],
        price: [100, 100],
        limit: 10,
        bgimage:
          "https://illust.download/wp-content/uploads/2017/11/background134.jpg",
      },
      {
        // 2組
        store: "桐頌堀",
        variety: 2,
        title: ["お好み焼き(プレーン)", "お好み焼き(チーズ入り)"],
        explain: ["ただのお好み焼き", "少し黄色いお好み焼き"],
        picture: ["", ""],
        price: [100, 100],
        limit: 10,
        bgimage:
          "https://illust.download/wp-content/uploads/2017/11/background137.jpg",
      },

      {
        // 3組
        store: "だんご3-3兄弟",
        variety: 2,
        title: ["みたらしきなこ団子", "カラフルあんこ団子"],
        explain: ["みたらし (きなこトッピング可能)", "あんこ"],
        picture: ["", ""],
        price: [100, 100],
        limit: 10,
        bgimage:
          "https://illust.download/wp-content/uploads/2017/11/background135.jpg",
      },
      {
        // 4組
        store: "もりてつフローズンパラダイス",
        variety: 2,
        title: ["かき氷(抹茶白玉小豆)", "かき氷(マンゴー)"],
        explain: ["抹茶味で白玉と小豆があるやつ", "マンゴー味"],
        picture: ["", ""],
        price: [100, 100],
        limit: 10,
        bgimage:
          "https://illust.download/wp-content/uploads/2017/11/background138.jpg",
      },
      {
        // 5組
        store: "じゃがいもだけじゃだめですか",
        variety: 2,
        title: [
          "シャカシャカポテト(コンソメ)",
          "シャカシャカポテト(バター醤油)",
        ],
        explain: ["うまい", "うまい"],
        picture: ["", ""],
        price: [200, 200],
        limit: 10,
        bgimage:
          "https://illust.download/wp-content/uploads/2017/11/background136.jpg",
      },

      {
        // 6組
        store: "ひっぱりだこ",
        variety: 2,
        title: ["たこ焼き", "たこ焼き(明太もちチーズ)"],
        explain: ["通常", "突然変異"],
        picture: ["", ""],
        price: [100, 100],
        limit: 10,
        bgimage:
          "https://illust.download/wp-content/uploads/2017/11/background133.jpg",
      },
    ];

    function updateDisplay(data) {
      if (!data || !data.user || !classDatas[data.user]) {
        // データがないか、ユーザー情報が不正な場合は何もしない
        return;
      }
      // 店名・番号・状況を反映
      document.querySelector(".store").innerText =
        classDatas[data["user"]].store;
      document.querySelector(".orderNum").innerText = data["id"];
      
      let statusText = data["status"];
      let statusClass = "";
      if (statusText === "呼び出し待ち") {
        if (data.wait_number !== undefined && data.wait_number !== null) {
          statusText = `呼び出し待ち (${data.wait_number}人待ち)`;
        } else {
          statusText = "呼び出し待ち";
        }
        statusClass = "text-warning";
      } else if (statusText === "キャンセル済み") {
        statusText = "キャンセル済み";
        statusClass = "text-danger";
      } else {
        statusText = "呼び出し中";
        statusClass = "text-success";
      }
      const statusEl = document.querySelector(".status");
      statusEl.innerText = statusText;
      statusEl.className = "status h2 fw-bold " + statusClass;


      // 注文内容を組み立てて反映
      let itemsHtml = "";
      const userClassData = classDatas[data["user"]];
      if (data.order_items && userClassData) {
        itemsHtml += `${userClassData.title[0]}：${
          data.order_items["item_1"] || 0
        }個<br/>`;
        itemsHtml += `${userClassData.title[1]}：${
          data.order_items["item_2"] || 0
        }個<br/>`;
      }
      document.querySelector(".items").innerHTML = itemsHtml;

      // 既存のタイマーをクリア
      if (cancellationInterval) {
        clearInterval(cancellationInterval);
      }
      const cancellationSection = document.getElementById("cancellation-section");
      if (data.status === "呼び出し中" && data.timestamp) {
        cancellationSection.style.display = "block";
        const cancellationInfo = document.getElementById("cancellation-info");

        // APIから返されるタイムスタンプをDateオブジェクトに変換
        const lastUpdatedTime = new Date(data.timestamp * 1000);

        // キャンセル猶予時間
        const cancellationTime = new Date(
          lastUpdatedTime.getTime() + CANCELLATION_GRACE_MINUTES * 60 * 1000
        );

        function updateCancellationTimer() {
          const now = new Date();
          const remainingMilliseconds = cancellationTime - now;

          if (remainingMilliseconds <= 0) {
            cancellationInfo.innerText = "キャンセル処理中です。";
            clearInterval(cancellationInterval);
            // ページをリロードしてステータスを更新
            setTimeout(() => {
                document.getElementById("reload-btn").click();
            }, 2000);
            return;
          }

          const remainingSeconds = Math.floor(remainingMilliseconds / 1000);
          const minutes = Math.floor(remainingSeconds / 60);
          const seconds = remainingSeconds % 60;

          const cancellationTimeString = cancellationTime.toLocaleTimeString(
            "ja-JP",
            { hour: "2-digit", minute: "2-digit" }
          );

          cancellationInfo.innerText = `${cancellationTimeString} にキャンセル (あと${minutes}分${seconds
            .toString()
            .padStart(2, "0")}秒)`;
        }

        updateCancellationTimer(); // まず一度呼び出す
        cancellationInterval = setInterval(updateCancellationTimer, 1000); // 1秒ごとに更新
      } else {
        cancellationSection.style.display = "none";
      }
    }

    const THROTTLE_TIME = 10000; // アクセス抑制時間（ミリ秒）
    const CANCELLATION_GRACE_MINUTES = 10; // キャンセル猶予時間（分）
    const cacheName = "status-cache"; // キャッシュ名を変更

    async function loadOrder() {
      const params = new URLSearchParams(window.location.search);
      const orderNum = params.get("order");
      const password_ = params.get("pw") || "";

      if (!orderNum) return;

      const orderRequestUrl = `${apiurl}mobile/get_order/${orderNum}`;
      try {
        const orderResponse = await fetch(orderRequestUrl, { 
          headers: { "Content-Type": "application/json", password: password_ }
        });

        if (!orderResponse.ok) {
          if (orderResponse.status === 404) {
            alert("注文番号が見つかりません。");
          } else if (orderResponse.status === 403) {
            alert("パスワードが間違っています。");
          } else {
            alert("注文情報の取得に失敗しました。");
          }
          return;
        }
        const orderData = await orderResponse.json();
        lastFullData = orderData;
        updateStatus(); // ステータス取得に進む
      } catch (error) {
        console.error("Fetch error on get_order:", error);
        alert("ネットワークエラーが発生しました。");
      }
    }

    async function updateStatus() {
      const reloadBtn = document.getElementById("reload-btn");
      const params = new URLSearchParams(window.location.search);
      const orderNum = params.get("order");
      const password_ = params.get("pw") || "";

      if (!orderNum) return;

      const statusRequestUrl = `${apiurl}mobile/get_status/${orderNum}`;
      const statusRequest = new Request(statusRequestUrl, {
        headers: { "Content-Type": "application/json", password: password_ },
      });

      const cache = await caches.open(cacheName);
      const cachedResponse = await cache.match(statusRequest);

      let statusData;

      if (cachedResponse) {
        const cachedTime = new Date(cachedResponse.headers.get("date")).getTime();
        const now = Date.now();

        if (now - cachedTime < THROTTLE_TIME) { // 10秒以内ならキャッシュを使う
          console.log("Loading status from cache.");
          statusData = await cachedResponse.json();
          reloadBtn.disabled = true;
          setTimeout(() => { reloadBtn.disabled = false; }, THROTTLE_TIME - (now - cachedTime));
        } 
      }
      
      if (!statusData) { // キャッシュがないか、古い場合
        console.log("Fetching status from network.");
        try {
          reloadBtn.disabled = true;
          const networkResponse = await fetch(statusRequest);
          if (networkResponse.ok) {
            await cache.put(statusRequest, networkResponse.clone());
            statusData = await networkResponse.json();
            setTimeout(() => { reloadBtn.disabled = false; }, THROTTLE_TIME);
          } else {
            alert("ステータスの更新に失敗しました。");
            reloadBtn.disabled = false;
          }
        } catch (error) {
          console.error("Fetch error on get_status:", error);
          alert("ネットワークエラーが発生しました。");
          reloadBtn.disabled = false;
        }
      }

      if (statusData) {
        const displayData = { ...lastFullData, ...statusData };
        updateDisplay(displayData);
        document.getElementById("last-updated").innerText = new Date().toLocaleString("ja-JP", { hour12: false });
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      const form = document.querySelector("form");
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const orderNum = form.elements["order"].value;
        const password = form.elements["pw"].value;
        if (orderNum) {
          const currentParams = new URLSearchParams(window.location.search);
          currentParams.set("order", orderNum);
          currentParams.set("pw", password);
          window.location.search = currentParams.toString();
        }
      });

      // 新しい処理フロー
      const params = new URLSearchParams(window.location.search);
      const orderNum = params.get("order");

      if (orderNum) {
        document.getElementById("root").style.display = "none";
        document.getElementById("status").style.display = "block";
        loadOrder();
      } else {
        document.getElementById("root").style.display = "block";
        document.getElementById("status").style.display = "none";
      }

      document.getElementById("reload-btn").addEventListener("click", () => updateStatus());
      window.addEventListener("popstate", () => location.reload());
    });
    </script>
</body>
</html>